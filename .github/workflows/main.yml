name: Robot Sikuli - Linux CI (JAR Pré-construído)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sikuli-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar ambiente Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependências do sistema e GUI
        run: |
          sudo apt-get update
          # Instala dependências X11 e Tesseract (OCR usado pelo Sikuli)
          sudo apt-get install -y \
            xvfb x11-utils libxtst6 libxrender1 libxi6 \
            tesseract-ocr tesseract-ocr-eng \
            wget

      - name: Instalar dependências Python
        run: |
          pip install --upgrade pip
          pip install robotframework
          # Esta instalação já inclui o SikuliLibrary.jar
          pip install robotframework-SikuliLibrary

      - name: Baixar SikuliX API JAR
        run: |
          wget -O sikulixapi.jar "https://launchpad.net/sikuli/sikulix/2.0.5/+download/sikulixapi-2.0.5.jar"
          echo "✅ sikulixapi.jar baixado"

      - name: Configurar ambiente e display virtual
        run: |
          mkdir -p ~/.Sikulix/SikulixStore
          echo "$(pwd)/sikulixapi.jar" > ~/.Sikulix/SikulixStore/lastUsedJar.txt
          
          # Iniciar Xvfb
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          export DISPLAY=:99
          sleep 3
          xdpyinfo -display $DISPLAY > /dev/null && echo "✅ Xvfb OK" || echo "❌ Xvfb Falhou"

      - name: Encontrar e verificar JAR da biblioteca
        run: |
          # Encontra o caminho exato do SikuliLibrary.jar instalado pelo pip
          LIB_JAR_PATH=$(python -c "import SikuliLibrary, os; print(os.path.join(os.path.dirname(SikuliLibrary.__file__), 'lib', 'SikuliLibrary.jar'))")
          echo "Caminho do SikuliLibrary.jar: $LIB_JAR_PATH"
          ls -la "$LIB_JAR_PATH"
          # Verifica se é um JAR válido
          jar tf "$LIB_JAR_PATH" > /dev/null && echo "✅ JAR é válido" || echo "❌ JAR inválido"

      - name: Iniciar servidor remoto (Modo NEW)
        run: |
          LIB_JAR_PATH=$(python -c "import SikuliLibrary, os; print(os.path.join(os.path.dirname(SikuliLibrary.__file__), 'lib', 'SikuliLibrary.jar'))")
          echo "Iniciando servidor remoto..."
          # NOTA: A classe principal pode ser diferente. Vamos tentar a mais comum.
          java -cp "$LIB_JAR_PATH:sikulixapi.jar" \
               org.robotframework.remoteserver.RemoteServer \
               --allow-stop true &
          SERVER_PID=$!
          sleep 10
          # Verifica se a porta está aberta
          if netstat -tln | grep :10000 > /dev/null; then
            echo "✅ Servidor remoto ouvindo na porta(PID: $SERVER_PID)"
          else
            echo "❌ Servidor não está ouvindo na porta 10000. Tentando diagnóstico..."
            # Tenta ver se o processo Java está vivo e qual porta está usando
            netstat -tlnp | grep java || true
            ps aux | grep RemoteServer || true
            # Não falha imediatamente, o teste pode ainda conectar
          fi

      - name: Executar testes Robot (modo NEW simples)
        run: |
          
          robot -d results tests/
          echo "Status de saída do robot: $?"

      - name: Coletar logs em caso de falha
        if: failure()
        run: |
          echo "=== COLETANDO LOGS DE DIAGNÓSTICO ==="
          ps aux | grep -E "(java|Xvfb)" || true
          netstat -tlnp || true
          if [ -f robot_output.log ]; then tail -100 robot_output.log; fi

      - name: Parar serviços
        if: always()
        run: |
          pkill -f RemoteServer 2>/dev/null || true
          pkill -f Xvfb 2>/dev/null || true

      - name: Publicar resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sikuli-results
          path: |
            results/
            robot_output.log
          retention-days: 7