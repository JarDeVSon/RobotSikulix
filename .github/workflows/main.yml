name: Robot Sikuli - Linux CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sikuli-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar ambiente Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependências do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            x11-utils \
            x11-apps \
            libxtst6 \
            libxrender1 \
            libxi6 \
            wget

      - name: Instalar APENAS a biblioteca correta
        run: |
          pip install --upgrade pip
          pip install robotframework
          # Instalar APENAS a biblioteca SikuliLibrary (que você já tem funcionando)
          pip install robotframework-SikuliLibrary
          
          # Verificar instalação CORRETA
          python -c "import SikuliLibrary; print('✅ SikuliLibrary importada com sucesso')"

      - name: Baixar SikuliX JAR
        run: |
          wget -O sikulixapi.jar "https://launchpad.net/sikuli/sikulix/2.0.5/+download/sikulixapi-2.0.5.jar"
          echo "✅ JAR baixado: $(ls -lh sikulixapi.jar)"

      - name: Preparar ambiente
        run: |
          # Criar diretórios necessários
          mkdir -p results/screenshots ~/.Sikulix/SikulixStore
          
          # Configurar arquivo do SikuliX (resolve erro "FileManager: writeStringToFile")
          echo "$(pwd)/sikulixapi.jar" > ~/.Sikulix/SikulixStore/lastUsedJar.txt
          
          echo "✅ Ambiente preparado"

      - name: Configurar display virtual Xvfb
        run: |
          # Iniciar Xvfb (ignorar warnings do xkbcomp)
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset 2>/dev/null &
          sleep 5
          
          export DISPLAY=:99
          
          # Testar se o display funciona
          if xdpyinfo -display $DISPLAY > /dev/null 2>&1; then
            echo "✅ Display virtual configurado: $DISPLAY"
          else
            echo "❌ Falha no display virtual"
            exit 1
          fi

      - name: Iniciar SikuliX Server CORRETAMENTE
        run: |
          echo "Iniciando SikuliX Server..."
          # O comando CORRETO para SikuliX 2.0.5: iniciar servidor na porta automática
          java -jar sikulixapi.jar -s -p 0 &
          SIKULI_PID=$!
          sleep 10
          
          # Verificar se o processo Java do SikuliX está rodando
          if ps -p $SIKULI_PID > /dev/null; then
            echo "✅ SikuliX Server iniciado (PID: $SIKULI_PID)"
            # Verificar a porta
            echo "Verificando portas abertas pelo Java:"
            netstat -tlnp | grep java || echo "Não foi possível verificar a porta com netstat, tentando lsof..."
            lsof -i -P -n | grep java 2>/dev/null || echo "lsof não disponível"
          else
            echo "❌ SikuliX Server não iniciou"
            echo "Tentando ver o log do processo:"
            # Não temos o log, mas podemos tentar ver se há algum erro no início
            # Vamos tentar iniciar em primeiro plano para ver o erro
            java -jar sikulixapi.jar -s -p 0 2>&1 | head -50
            exit 1
          fi
      - name: Executar testes
        run: |
          echo "=== EXECUTANDO TESTES ==="
          
          # IMPORTANTE: A biblioteca SikuliLibrary espera a variável SIKULI_PATH
          export SIKULI_PATH=$(pwd)/sikulixapi.jar
          
          # Executar testes com timeout maior
          robot -d results \
                --variable SIKULI_PATH:$SIKULI_PATH \
                --variable DISPLAY:$DISPLAY \
                --variable TIMEOUT:60 \
                --loglevel TRACE \
                tests/
          
          echo "✅ Testes executados"

      - name: Limpar processos
        if: always()
        run: |
          pkill -f "sikulixapi" 2>/dev/null || true
          pkill -f "Xvfb.*:99" 2>/dev/null || true

      - name: Publicar resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sikuli-results
          path: results/
          retention-days: 7