name: Robot Sikuli - Linux

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sikuli-linux:
    runs-on: ubuntu-latest  # Runner Linux hospedado pelo GitHub
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar ambiente Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Configurar display virtual (Xvfb)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils x11-apps libxtst6 libxrender1 libxi6

      - name: Instalar dependências Python
        run: |
          pip install --upgrade pip
          pip install robotframework
          pip install robotframework-sikulixlibrary
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Baixar SikuliX
        run: |
          wget -O sikulix.jar "https://launchpad.net/sikuli/sikulix/2.0.5/+download/sikulixapi-2.0.5.jar"
          ls -lh sikulix.jar

      - name: Executar testes com display virtual
        run: |
          # Inicia Xvfb em background
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99
          
          # Dá tempo para o display inicializar
          sleep 5
          
          # Inicia SikuliX Server
          java -jar sikulix.jar -r -s &
          sleep 10
          
          # Executa os testes
          robot -d results tests/
          
          # Para os serviços
          killall java
          killall Xvfb

      - name: Publicar resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sikuli-linux-results
          path: results/