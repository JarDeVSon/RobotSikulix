name: Robot Sikuli - Linux CI (Modo NEW Corrigido)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sikuli-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar ambiente Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependências do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            x11-utils \
            libxtst6 \
            libxrender1 \
            libxi6 \
            wget

      - name: Instalar biblioteca Robot e Sikuli
        run: |
          pip install --upgrade pip
          pip install robotframework
          # Instala APENAS a biblioteca cliente
          pip install robotframework-SikuliLibrary
          python -c "import SikuliLibrary; print('✅ SikuliLibrary importada')"

      - name: Baixar SikuliX API JAR
        run: |
          wget -O sikulixapi.jar "https://launchpad.net/sikuli/sikulix/2.0.5/+download/sikulixapi-2.0.5.jar"
          echo "✅ JAR baixado: $(ls -lh sikulixapi.jar)"

      - name: Configurar display virtual Xvfb
        run: |
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          export DISPLAY=:99
          sleep 5
          if xdpyinfo -display $DISPLAY > /dev/null 2>&1; then
            echo "✅ Display virtual OK"
          else
            echo "❌ Display virtual falhou"; exit 1
          fi

      - name: Iniciar Servidor Sikuli Remoto (Modo NEW)
        run: |
          # Esta é a forma CORRETA de iniciar o servidor remoto incluído na biblioteca
          # O servidor precisa do JAR do SikuliX no classpath
          java -cp "sikulixapi.jar:/opt/hostedtoolcache/Python/3.10.19/x64/lib/python3.10/site-packages/SikuliLibrary/lib/SikuliLibrary.jar" \
               org.robotframework.remoteserver.RemoteServer \
               --library SikuliLibrary.SikuliLibrary \
               --port 10000 \
               --allow-stop true &
          SERVER_PID=$!
          sleep 10
          if ps -p $SERVER_PID > /dev/null; then
            echo "✅ Servidor remoto iniciado (PID: $SERVER_PID) na porta 10000"
          else
            echo "❌ Servidor não iniciou. Verifique o classpath e logs."; exit 1
          fi

      - name: Executar testes Robot
        run: |
          # A variável REMOTE_SERVER_URL é usada pela biblioteca em modo NEW
          export REMOTE_SERVER_URL=http://127.0.0.1:10000
          export SIKULI_PATH=$(pwd)/sikulixapi.jar

          robot -d results \
                --variable REMOTE_SERVER_URL:$REMOTE_SERVER_URL \
                --variable SIKULI_PATH:$SIKULI_PATH \
                --variable DISPLAY::99 \
                --variable DEFAULT_TIMEOUT:60 \
                --loglevel DEBUG \
                tests/
          echo "✅ Testes executados"

      - name: Parar servidor remoto e limpar
        if: always()
        run: |
          pkill -f "RemoteServer" 2>/dev/null || true
          pkill -f "Xvfb.*:99" 2>/dev/null || true

      - name: Publicar resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sikuli-results
          path: results/
          retention-days: 7